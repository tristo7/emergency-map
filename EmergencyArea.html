<!DOCTYPE html>
<html>
  <head>
    <title>EM Map</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="EmergencyArea.css">
	<script src="jquery-3.1.1.min.js"></script>
  </head>
  <body>
		<h1>Emergency Management Map</h1>
		<p>Deploy Testing---3</p>
		<div id="map"></div>
		<section class="loginform cf" id="loginForm">
			<form name="login" action="index_submit" method="get" accept-charset="utf-8">
			  <ul>
			    <li><label for="username">Username</label>
			    <input type="text" name="username" placeholder="username" id="username" required></li>
			    <li><label for="password">Password</label>
			    <input type="password" name="password" placeholder="password" id="password"required></li>
			    <li>
			    <input type="button" value="Login" onclick="verifyLogin()"></li>
			  </ul>
			</form>
		</section>
	<script type="text/javascript">
		var loggedIn = false;
		function verifyLogin(){
			var user = document.getElementById("username").value;
			var pass = document.getElementById("password").value;
			if(user == "jsu" && pass == "jsu"){
				loggedIn = true;
				document.getElementById('loginForm').remove();
				initMap();
			}
		}
		function initMap() {
			var map = new google.maps.Map(document.getElementById('map'), {
			  center: {lat: 33.828640, lng: -85.763048},
			  zoom: 15
			});
			var infoWindow = new google.maps.InfoWindow({map: map});
			
			//get location of current user (will not work over HTTPS, disabling for now)
			/*
			if (navigator.geolocation) {
			  navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
				  lat: position.coords.latitude,
				  lng: position.coords.longitude
				};

				infoWindow.setPosition(pos);
				infoWindow.setContent('Location found.');
				map.setCenter(pos);
				map.setZoom(15);
			  }, function() {
				handleLocationError(true, infoWindow, map.getCenter());
			  });
			} else {
			  // Browser doesn't support Geolocation
			  handleLocationError(false, infoWindow, map.getCenter());
			}
			*/
			
			//load current polygons
			var results = $.getJSON("IO.php", function(result){
				//console.log(result);
				$.each(result, function(i, field){
					//console.log(field.latLngArray);
					//console.log(field.expiration);
					//console.log(field.description);
					var paths = [];
					//console.log(JSON.parse(field.latLngArray));
					var tempPoly = new google.maps.Polygon({ //TODO: also add info window to polygon.
						paths:JSON.parse(field.latLngArray),
						fillColor: '#ff9980',
						fillOpacity: 0.35,
						strokeWeight: 1,
						strokeColor: '#ff0000'
					});
					
					tempPoly.setMap(map);
					addInfoWindow(tempPoly,field.expiration,field.description);
				});
			});
			
			
			
			function addInfoWindow(polygon, expir, desc){
				var contentString = '<div id="content">'+
				  '<div id="siteNotice">'+
				  '</div>'+
				  '<h2 id="expiration">Expiration</h2>'+
				  '<p>'+expir+''+
				  '<h2 id="description" >Description</h2>'+
				  '<p>'+desc+''+
				  '</div>';
				var info = new google.maps.InfoWindow({
					content: contentString
				});
				
				//generate infowindow when user clicks on the polygon.
				google.maps.event.addListener(polygon, 'click', function(event){
					//currently only displays expiration and details
					//would like to add a custom menu to have several features (edit details/expirate, delete, edit fence, etc)
					info.setPosition(event.latLng);
					info.open(map);
				});
			}
			
			//VERY rough login method... not enforcable
			
			//TODO: improve login security
			if(loggedIn){
				var drawingManager = new google.maps.drawing.DrawingManager({
					polygonOptions: {
						fillColor: '#ff9980',
						fillOpacity: 0.35,
						strokeWeight: 1,
						strokeColor: '#ff0000'
					},
					drawingMode: google.maps.drawing.OverlayType.NULL,
					drawingControl: true,
					drawingControlOptions: {
						position: google.maps.ControlPosition.TOP_CENTER,
						drawingModes: ['polygon']
					}
					
				});
				drawingManager.setMap(map);
				
				google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
					var verticles = polygon.getPath();
					var latLngArray = polygon.getPath().getArray();
					
					//rough method for user to give expiration and description of the fence.
					//TODO: Improve method for user to give expiration & description.
					var expiration = prompt("Please enter the expiration time (YYYY-MM-DD HH-MM-SS)", "2016-10-25 12:00:00");
					var description = prompt("Please enter a description", "Tornado warning/Road hazard/etc");
					
					//add popup window on polygon click for info.
					addInfoWindow(polygon, expiration, description);
					
					var sendData = {
						latlng: JSON.stringify(latLngArray),
						expires: expiration,
						desc: description
					};
					
					$.ajax({
						url: 'IO.php',
						type: 'POST',
						success: function (data) {
							console.log("Data sent to database.");
						},
						data: {
							latlng: JSON.stringify(latLngArray),
							expires: expiration,
							desc: description
						}
					});
				});
			} 
		}

		function handleLocationError(browserHasGeolocation, infoWindow, pos) {
			infoWindow.setPosition(pos);
			infoWindow.setContent(browserHasGeolocation ?
								  'Error: The Geolocation service failed.' :
								  'Error: Your browser doesn\'t support geolocation.');
		}
	
	</script>
	
	<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgrYOrdmh3-jkJHk9ibXBrfQIeFAUPhak&libraries=drawing&callback=initMap">
    </script>
  </body>
</html>