<!DOCTYPE html>
<html>
  <head>
    <title>EM Map</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="EmergencyArea.css">
	<script src="jquery-3.1.1.min.js"></script>
  </head>
  <body>
		<h1>Emergency Management Map</h1>
		<section class="loginform cf" id="loginForm">
			<form name="login" action="index_submit" method="get" accept-charset="utf-8">
			  <ul>
			    <li><label for="username">Username</label>
			    <input type="text" name="username" placeholder="username" id="username" required></li>
			    <li><label for="password">Password</label>
			    <input type="password" name="password" placeholder="password" id="password"required></li>
			    <li>
			    <input type="button" value="Login" onclick="verifyLogin()"></li>
			  </ul>
			</form>
		</section>
		<div id="map"></div>
		<!-- The Modal -->
		<div id="myModal" class="modal">
		    <!-- Modal content -->
		    <div class="modal-content">
				<div class="modal-header">
					<span class="close">×</span>
					<h2>Polygon Information</h2>
				</div>
				<div class="modal-body">
					<form name="polygon_info" method="get" accept-charset="utf-8">
			  		<ul>
					    <li><label for="expiration">Expiration</label>
					    <input type="datetime-local" name="expiration" placeholder="" id="expiration" required></li>
					    <li><label for="description">Description</label>
					    <input type="text" name="description" placeholder="Additional Information" id="description"required></li>
						<li><label for="type">Type</label>
						    <select name="type">
								<option value="tornado">Tornado</option>
								<option value="fire">Fire</option>
								<option value="road_hazard">Road Hazard</option>
								<option value="other">Other</option>
							</select></li>
					    <li><input type="button" value="Finish" onclick="addPoly()"></li>
			  		</ul>
			</form>
				</div>
				<div class="modal-footer">
					<h3>Polygon Information</h3>
				</div>
			</div>
		</div>
	<script type="text/javascript">
		var loggedIn = false;
		var currentPolygon;
		function verifyLogin(){
			var user = document.getElementById("username").value;
			var pass = document.getElementById("password").value;
			if(user == "jsu" && pass == "jsu"){
				loggedIn = true;
				document.getElementById('loginForm').remove();
				initMap();
			}
		}
		function initMap() {
			if(loggedIn){
				var map = new google.maps.Map(document.getElementById('map'), {
				  center: {lat: 33.828640, lng: -85.763048},
				  zoom: 15
				});
				var infoWindow = new google.maps.InfoWindow({map: map});
				
				//load current polygons
				var results = $.getJSON("IO.php", function(result){
					//console.log(result);
					$.each(result, function(i, field){
						//console.log(field.latLngArray);
						//console.log(field.expiration);
						//console.log(field.description);
						var paths = [];
						//console.log(JSON.parse(field.latLngArray));
						var tempPoly = new google.maps.Polygon({ //TODO: also add info window to polygon.
							paths:JSON.parse(field.latLngArray),
							fillColor: '#ff9980',
							fillOpacity: 0.35,
							strokeWeight: 1,
							strokeColor: '#ff0000'
						});
						
						tempPoly.setMap(map);
						addInfoWindow(tempPoly,field.expiration,field.description);
					});
				});
				
				
				
				function addInfoWindow(polygon, expir, desc){
					var contentString = '<div id="content">'+
					  '<div id="siteNotice">'+
					  '</div>'+
					  '<h2 id="expiration">Expiration</h2>'+
					  '<p>'+expir+''+
					  '<h2 id="description" >Description</h2>'+
					  '<p>'+desc+''+
					  '</div>';
					var info = new google.maps.InfoWindow({
						content: contentString
					});
					
					//generate infowindow when user clicks on the polygon.
					google.maps.event.addListener(polygon, 'click', function(event){
						//currently only displays expiration and details
						//would like to add a custom menu to have several features (edit details/expirate, delete, edit fence, etc)
						info.setPosition(event.latLng);
						info.open(map);
					});
				}
				
				var drawingManager = new google.maps.drawing.DrawingManager({
					polygonOptions: {
						fillColor: '#ff9980',
						fillOpacity: 0.35,
						strokeWeight: 1,
						strokeColor: '#ff0000'
					},
					drawingMode: google.maps.drawing.OverlayType.NULL,
					drawingControl: true,
					drawingControlOptions: {
						position: google.maps.ControlPosition.TOP_CENTER,
						drawingModes: ['polygon']
					}
					
				});
				drawingManager.setMap(map);
					
				google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
					currentPolygon = polygon;
					
					
					//popup form start
					
					// Get the modal
					var modal = document.getElementById('myModal');
					
					// Get the <span> element that closes the modal
					var span = document.getElementsByClassName("close")[0];

					// show the modal
					modal.style.display = "block";
						
					// When the user clicks on <span> (x), close the modal
					span.onclick = function() {
						modal.style.display = "none";
					}

					// When the user clicks anywhere outside of the modal, close it
					window.onclick = function(event) {
						if (event.target == modal) {
							modal.close();
						}
					}
					
					//popup form end
					//var expiration = prompt("Please enter the expiration time (YYYY-MM-DD HH-MM-SS)", "2016-10-25 12:00:00");
					//var description = prompt("Please enter a description", "Tornado warning/Road hazard/etc");
				});
			}
		}
		
		function addPoly(){
				var polygon = currentPolygon;
				var verticles = polygon.getPath();
				var latLngArray = polygon.getPath().getArray();
				//add popup window on polygon click for info.
				//addInfoWindow(polygon, expiration, description);
				
				var sendData = {
					latlng: JSON.stringify(latLngArray),
					expires: expiration,
					desc: description
				};
				
				$.ajax({
					url: 'IO.php',
					type: 'POST',
					success: function (data) {
						console.log("Data sent to database.");
					},
					data: {
						latlng: JSON.stringify(latLngArray),
						expires: expiration,
						desc: description
					}
				});
				initMap();
			}
	</script>
	
	<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgrYOrdmh3-jkJHk9ibXBrfQIeFAUPhak&libraries=drawing&callback=initMap"></script>
  </body>
</html>